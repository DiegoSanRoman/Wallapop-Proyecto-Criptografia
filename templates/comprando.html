<!DOCTYPE html>
<html lang="es">
<head>
    <title>Comprar</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/comprando.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='imagenes/wallapop.png') }}" type="image/png">
</head>
<body>
    <nav>
        <a class="selected" href="{{ url_for('app_route') }}">Inicio</a>
        <a href="{{ url_for('perfil') }}">Mi Perfil</a>
        <a href="{{ url_for('amigos') }}">Mis Amigos</a>
        <a href="{{ url_for('productos') }}">Mis Productos</a>
        <a href="{{ url_for('carrito') }}">Mi Carrito</a>
        <img src="{{ url_for('static', filename='imagenes/perfil.png') }}" alt="Perfil" id="profile-img">
        <div class="dropdown-menu" id="dropdown-menu">
            <a id="cerrar-sesion" href="{{ url_for('home') }}">Cerrar sesión</a>
        </div>
    </nav>

    <script src="{{ url_for('static', filename='scripts/home.js') }}"></script>

    <h1>Comprar Producto: {{ product.name }}</h1>
    <p>Descripción: {{ product.description }}</p>
    <p>Precio: {{ product.price }} €</p>
    <p>Vendedor: {{ seller.nombre }} - {{ seller.ciudad }}</p>

    <h2>Usted va a pagar con este número de cuenta: {{ bank_account }}</h2>
    <p>Método de cifrado: {{ algorithm }}</p>
    <p>Longitud de la clave: {{ key_length }} bits</p>

    <!-- Botón para verificar el certificado del vendedor -->
    <button id="verificar-certificado">Comprobar Certificado del Vendedor</button>
    <div id="resultado-verificacion"></div>

    <!-- Botón para verificar la firma del producto -->
    <button id="verificar-firma">Comprobar Firma del Producto</button>
    <div id="resultado-verificacion-firma"></div>

    <form action="{{ url_for('solicitar_compra') }}" method="POST">
        <h2>Mensaje para el comprador</h2>
        <input type="hidden" name="product_id" value="{{ product.id }}">
        <input type="hidden" name="seller_id" value="{{ seller.id }}">
        <label for="message">Mensaje para el vendedor:</label>
        <textarea id="message" name="message" required></textarea>

        <div class="botones">
            <button type="submit">Comprar</button>
            <a class="boton" href="{{ url_for('comprar') }}"><button type="button">Cancelar</button></a>
        </div>
    </form>

    <script>
        // Verificar el certificado del vendedor
        document.getElementById('verificar-certificado').addEventListener('click', function() {
            const sellerId = {{ seller.id }};
            fetch('{{ url_for('verificar_certificado_vendedor') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'seller_id=' + sellerId
            })
            .then(response => response.json())
            .then(data => {
                const resultadoDiv = document.getElementById('resultado-verificacion');
                if (data.status === 'success') {
                    resultadoDiv.innerHTML = '<p style="color: green;">' + data.message + '</p>';
                } else {
                    resultadoDiv.innerHTML = '<p style="color: red;">' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultado-verificacion').innerHTML = '<p style="color: red;">Error al verificar el certificado.</p>';
            });
        });

        // Verificar la firma del producto
        document.getElementById('verificar-firma').addEventListener('click', function() {
            const productId = {{ product.id }};
            fetch('{{ url_for('verificar_firma_producto') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'product_id=' + productId
            })
            .then(response => response.json())
            .then(data => {
                const resultadoDiv = document.getElementById('resultado-verificacion-firma');
                if (data.status === 'success') {
                    resultadoDiv.innerHTML = '<p style="color: green;">' + data.message + '</p>';
                } else {
                    resultadoDiv.innerHTML = '<p style="color: red;">' + data.message + '</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('resultado-verificacion-firma').innerHTML = '<p style="color: red;">Error al verificar la firma.</p>';
            });
        });
    </script>
</body>
</html>
